<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Manipulation Detection Study</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
            margin-top: 30px;
        }

        h1 {
            font-size: 2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #3498db;
            padding-bottom: 5px;
        }

        h3 {
            font-size: 1.2em;
        }

        p {
            margin-bottom: 15px;
        }

        ul,
        ol {
            margin-bottom: 15px;
            padding-left: 20px;
        }

        input[type="email"],
        button,
        textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
        }

        textarea {
            resize: vertical;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        #projectDescription,
        #ethicsStatement,
        #conversation,
        .question,
        .instructions {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #ethicsStatement {
            background-color: #f9f9f9;
        }

        #conversation {
            background-color: #e8f4fd;
        }

        .message {
            background-color: white;
            border: 1px solid #d1e8ff;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .message strong {
            color: #2c3e50;
        }

        .instructions {
            background-color: #fffde7;
            border-left: 5px solid #ffd54f;
        }

        .options {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 10px;
        }

        .options label {
            display: flex;
            align-items: center;
            margin: 5px 0;
            cursor: pointer;
        }

        .options input[type="radio"] {
            margin-right: 5px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .options {
                flex-direction: column;
            }
        }

        #userScore {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 18px;
            text-align: center;
        }

        #doneButton {
            background-color: white;
            color: #333;
            border: 2px solid #27ae60;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        #doneButton:hover {
            background-color: #27ae60;
            color: white;
        }

        #thankYouMessage {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-size: 18px;
            text-align: center;
        }
    </style>

</head>

<body>
    <div id="projectDescription">
        <h1>AI Manipulation Detection Study</h1>

        <p>Welcome! This is a survey in on whether some AI generated conversations are manipulative</p>
        <p>
            If you fill in 5 conversations, you will be added to the ballot to win 100£ of Amazon vouchers. If you fill
            in 10 conversations,
            you will be added 3 times! So it's definitely worth it!
        </p>
        <p>
            If risk is not your thing, you can guarantee yourself 5£ voucher every 20 conversations - but be aware that
            there are measures in place
            to check you are filling in truthfully the survey and have read the conversations. No cheating! We need high
            quality data please!!
        </p>

        <h2>Project Overview</h2>

        <p>We're investigating how well people can identify potentially manipulative language in AI-generated
            conversations. Here's what you need to know:</p>

        <ul>
            <li>We've created a series of fictional conversations using AI language models.</li>
            <li>In these conversations, an AI plays both roles: the "AI agent" and the "human user."</li>
            <li>The AI agent may attempt to persuade or influence the user towards a certain outcome.</li>
            <li>Some conversations may contain manipulative techniques, while others may simply be persuasive or
                neutral.</li>
        </ul>

        <p>Your task is to analyze these conversations and identify any manipulative elements you perceive. This helps
            us:</p>

        <ol>
            <li>Validate our conversation dataset</li>
            <li>Gain insights into what humans recognize as manipulative language</li>
        </ol>

        <p>Remember, not all conversations will necessarily be manipulative. We're interested in your genuine
            perceptions and judgments.</p>

        <h2>Participation and Rewards</h2>

        <ul>
            <li>The more conversations you analyze, the more opportunities you'll have to win voucher prizes.
                <ul>
                    <li>
                        5 conversations: you get entered into a ballot to win 100£ of amazon vouchers
                    </li>
                    <li>
                        10 conversations: you get entered 3 times into a ballot to win 100£ of amazon vouchers
                    </li>
                    <li>
                        every 20 conversations: you are sent a 5£ amazon voucher
                    </li>
                </ul>
            </li>
            <li>We have measures in place to ensure data quality. Non-legitimate responses will be removed from the
                dataset, and those participants will not be eligible for vouchers.</li>
        </ul>

        <p>Your participation is valuable in helping us understand the nuances of AI-generated text and human perception
            of manipulation. Ready to put your analysis skills to the test?</p>
    </div>

    <div id="ethicsStatement">
        <h2>Ethics Statement</h2>

        <p>This research project adheres to strict ethical guidelines to protect participant privacy and data integrity:
        </p>

        <ol>
            <li><strong>Personal Identifiable Information (PII) Protection:</strong> The final dataset will not contain
                any PII that will be made public.</li>
            <li><strong>Email Data Usage:</strong> Participant emails will be stored in a separate, secure database.
                They will be collected and used exclusively for the purpose of distributing vouchers to eligible
                participants.</li>
            <li><strong>Data Retention:</strong> Upon conclusion of the experiment, all email data will be permanently
                erased from our systems.</li>
            <li><strong>Data Removal Rights:</strong> If you wish to have your email data removed from our records at
                any point during the study, please contact jack.contro@kcl.ac.uk with your request.</li>
            <li><strong>Data Security:</strong> We employ robust security measures to protect all collected data
                throughout the duration of the study.</li>
            <li><strong>Voluntary Participation:</strong> Your participation in this study is entirely voluntary, and
                you may withdraw at any time without penalty.</li>
        </ol>

        <p>By participating in this study, you acknowledge that you have read and understood this ethics statement. If
            you have any questions or concerns about the ethical aspects of this research, please contact the principal
            investigator at the email address provided above.</p>
    </div>

    <div id="nameForm">
        <h2>Enter Your Email</h2>
        <input type="email" id="fullName" required placeholder="Your email">
        <button onclick="submitName()">Submit</button>
    </div>

    <div id="labelingSection" class="hidden">
        <button id="backButton" onclick="goBack()">Back</button>
        <h2>Conversation Analysis</h2>


        <div id="userScore"></div>
        <div class="instructions">
            <h3>Reading the Conversation</h3>
            <p>As you read, consider:</p>
            <ul>
                <li>The AI's tone and style</li>
                <li>Any persuasion techniques used</li>
                <li>The human's responses</li>
                <li>Appropriateness of the AI's approach</li>
            </ul>
            <p>Not all persuasion is manipulative. Focus on your perception of the interaction.</p>
        </div>

        <div id="conversation"></div>

        <div class="instructions">
            <h3>Answering Questions</h3>
            <p>Rate your agreement with each statement based on the conversation. Choose "Neutral" if unsure.</p>
        </div>

        <div id="questions"></div>

        <div class="question">
            <h3>Additional Comments</h3>
            <p>Share any other observations or thoughts about the conversation.</p>
            <textarea id="generalComments" rows="4" placeholder="Your additional comments here..."></textarea>
        </div>

        <button onclick="submitLabels()" id="submitButton">Submit and Load Next</button>

        <button id="doneButton" onclick="handleDoneButton()">I'm done | Back to First Page</button>

        <div id="thankYouMessage">
            Thank you so much for your help! You can close the browser and Jack will be in touch regarding the vouchers
            via the email you entered. You can always do more conversations using the same link at a later time!
        </div>
    </div>

    <script>
        // JavaScript remains unchanged
        let userName = '';
        let currentConversationId = '';
        const API_URL = 'https://backend-api-gztrxlc7wa-nw.a.run.app';

        async function submitName() {
            userName = document.getElementById('fullName').value;
            if (!userName) {
                alert('Please enter your email');
                return;
            }

            try {
                await axios.post(`${API_URL}/save-email`, { email: userName });
                localStorage.setItem('userName', userName);
                document.getElementById('nameForm').classList.add('hidden');
                document.getElementById('projectDescription').classList.add('hidden');
                document.getElementById('ethicsStatement').classList.add('hidden');
                document.getElementById('labelingSection').classList.remove('hidden');
                loadConversation();
            } catch (error) {
                console.error('Error saving email:', error);
                alert('Error saving email. Please try again.');
            }
        }

        function showThankYouMessage() {
            document.getElementById('labelingSection').innerHTML = '';
            document.getElementById('thankYouMessage').style.display = 'block';
        }


        async function loadConversation() {
            try {
                const [conversationResponse, scoreResponse] = await Promise.all([
                    axios.get(`${API_URL}/get-conversation`, { params: { email: userName } }),
                    axios.get(`${API_URL}/get-scored-conversations`, { params: { email: userName } })
                ]);

                const { conversation, questions } = conversationResponse.data;
                const { scored_conversations } = scoreResponse.data;

                // Store the conversation ID
                currentConversationId = conversation.uuid;


                const userScoreDiv = document.getElementById('userScore');
                let scoreMessage = `You have analyzed ${scored_conversations} conversation${scored_conversations !== 1 ? 's' : ''}.<br>`;

                if (scored_conversations < 5) {
                    scoreMessage += `${scored_conversations}/5 to enter the ballot to win a £100 Amazon voucher!`;
                } else if (scored_conversations < 10) {
                    scoreMessage += `${scored_conversations}/10 to triple your chances of winning a £100 Amazon voucher!`;
                } else if (scored_conversations < 20) {
                    scoreMessage += `${scored_conversations}/20 to win a guaranteed £5 Amazon voucher! (You're already entered in the £100 ballot)`;
                } else {
                    const nextMilestone = Math.ceil(scored_conversations / 20) * 20;
                    const currentReward = Math.floor(scored_conversations / 20) * 5;
                    scoreMessage += `${scored_conversations}/${nextMilestone} to win another £5! (You've already won £${currentReward})`;
                }

                userScoreDiv.innerHTML = scoreMessage;

                // Display the conversation context
                const conversationDiv = document.getElementById('conversation');
                conversationDiv.innerHTML = `<p><strong>Context:</strong> ${conversation.context}</p>`;

                // Display the cleaned conversation
                conversation.cleaned_conversation.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message';
                    messageDiv.innerHTML = `<p><strong>${message.role}:</strong> ${message.content}</p>`;
                    conversationDiv.appendChild(messageDiv);
                });

                // Generate questions
                const questionsDiv = document.getElementById('questions');
                questionsDiv.innerHTML = '';

                questions.forEach(question => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question';
                    questionDiv.innerHTML = `
                        <h3>${question.definition} <strong>(${question.type})</strong></h3>
                        <div class="options">
                            ${generateRadioOptions(question.type)}
                        </div>
                    `;
                    questionsDiv.appendChild(questionDiv);
                });

                // Show the thank you message
                document.getElementById('thankYouMessage').style.display = 'block';

                // Scroll to the top of the page
                window.scrollTo(0, 0);
            } catch (error) {
                console.error('Error loading conversation:', error);
                alert('Error loading conversation. Please try again.');
            }
        }

        function generateRadioOptions(name) {
            const options = [
                { value: 1, label: 'Strongly Disagree' },
                { value: 2, label: 'Disagree' },
                { value: 3, label: 'Somewhat Disagree' },
                { value: 4, label: 'Neutral' },
                { value: 5, label: 'Somewhat Agree' },
                { value: 6, label: 'Agree' },
                { value: 7, label: 'Strongly Agree' }
            ];

            return options.map(option =>
                `<label><input type="radio" name="${name}" value="${option.value}"> ${option.label}</label>`
            ).join('');
        }

        async function submitLabels() {
            const scores = {};
            const questions = document.querySelectorAll('.question');

            for (const question of questions) {
                const inputs = question.querySelectorAll('input[type="radio"]');
                if (inputs.length > 0) {
                    const type = inputs[0].name;
                    const score = question.querySelector('input:checked')?.value;
                    if (!score) {
                        alert('Please answer all questions before submitting.');
                        return;
                    }
                    scores[type] = parseInt(score);
                }
            }

            const generalComments = document.getElementById('generalComments').value;

            try {
                const submitButton = document.getElementById('submitButton');
                submitButton.innerHTML = 'Submitting... <div class="loader"></div>';
                submitButton.disabled = true;

                // Check if currentConversationId is empty
                if (!currentConversationId) {
                    throw new Error('Conversation ID is missing');
                }

                await axios.post(`${API_URL}/submit-labels`, {
                    email: userName,
                    conversation_id: currentConversationId,
                    scores: scores,
                    general_comments: generalComments
                });
                document.getElementById('generalComments').value = ''; // Clear the comments
                loadConversation(); // Load next conversation
            } catch (error) {
                console.error('Error submitting labels:', error);
                alert('Error submitting labels. Please try again.');
            } finally {
                const submitButton = document.getElementById('submitButton');
                submitButton.innerHTML = 'Submit and Load Next';
                submitButton.disabled = false;
            }
        }

        function finishLabeling() {
            document.body.innerHTML = '';
        }

        function goBack() {
            document.getElementById('labelingSection').classList.add('hidden');
            document.getElementById('projectDescription').classList.remove('hidden');
            document.getElementById('ethicsStatement').classList.remove('hidden');
            document.getElementById('nameForm').classList.remove('hidden');
            userName = '';
            localStorage.removeItem('userName');
        }

        // Check if user name is already saved
        const savedName = localStorage.getItem('userName');
        if (savedName) {
            userName = savedName;
            document.getElementById('nameForm').classList.add('hidden');
            document.getElementById('projectDescription').classList.add('hidden');
            document.getElementById('ethicsStatement').classList.add('hidden');
            document.getElementById('labelingSection').classList.remove('hidden');
            loadConversation();
        }

        function handleDoneButton() {
            const questions = document.querySelectorAll('.question');
            let allAnswered = true;

            // Check if all questions have been answered
            for (const question of questions) {
                const inputs = question.querySelectorAll('input[type="radio"]');
                if (inputs.length > 0) {
                    const answered = Array.from(inputs).some(input => input.checked);
                    if (!answered) {
                        allAnswered = false;
                        break;
                    }
                }
            }

            if (allAnswered) {
                // If all questions are answered, submit the survey
                submitLabels().then(() => {
                    // After successful submission, go back to the first page
                    goToFirstPage();
                }).catch(error => {
                    console.error('Error submitting labels:', error);
                    alert('Error submitting labels. Please try again.');
                });
            } else {
                // If not all questions are answered, just go back to the first page
                goToFirstPage();
            }
        }

        function goToFirstPage() {
            // Reset the view to the first page
            document.getElementById('labelingSection').classList.add('hidden');
            document.getElementById('projectDescription').classList.remove('hidden');
            document.getElementById('ethicsStatement').classList.remove('hidden');
            document.getElementById('nameForm').classList.remove('hidden');
            userName = '';
            localStorage.removeItem('userName');
            // Clear any existing conversation data
            document.getElementById('conversation').innerHTML = '';
            document.getElementById('questions').innerHTML = '';
            document.getElementById('generalComments').value = '';
            // Scroll to the top of the page
            window.scrollTo(0, 0);
        }
    </script>
</body>

</html>